var RunOrg=MakeRunOrg(jQuery);function MakeRunOrg(f){function p(w,v,u){if(typeof v=="string"){v={id:v}}v=v||{};u.forEach(function(x){w[x]=v[x]||null})}function q(w,u){var v={};p(v,w,u);return v}function j(v){var u=f.Deferred();u.resolve(v);return u}function m(u){if(typeof u=="object"&&u!==null&&"id" in u){return u.id}return u}function c(){return +new Date()}var h=null,i,t=null,r;function e(B,w,z,A){var v="?",u=f.Deferred(),x,y;z=z||{};if(t&&r<c()){t=null}if(typeof w=="string"){w=[w]}w=RunOrg.endpoint+"/db/"+RunOrg.db+"/"+w.join("/");t&&(z.at=t);h&&(z.as=i);for(x in z){if(z[x]===null){continue}w+=v+x+"="+z[x];v="&"}y={url:w,dataType:"json",type:B,beforeSend:function(C){h&&C.setRequestHeader("Authorization","RUNORG token="+h)}};if(B>"P"){y.data=JSON.stringify(A);y.contentType="application/json"}f.ajax(y).always(function(K,F,J){var M=("responseJSON" in K)?K:J,L=F=="success";if(L&&M.status<500){var G=M.responseJSON;if("at" in G){var I=t?JSON.parse(t):{},H,E,D=I.length,C=G.at;for(k in C){if(!(k in I)||I[k]<C[k]){I[k]=C[k]}}t=JSON.stringify(I);r=c()+60000}if("token" in G&&"self" in G){h=G.token;i=G.self.id}u.resolve(G)}else{u.reject(L?{HTTP:M.status}:{error:F})}});return u.promise()}function a(u){p(this,u,["id","label","gender","pic"])}a.prototype=Object.create({Load:function(){var u=this;return e("GET",["people",this.id]).then(function(v){a.call(u,v);return a.Cache(u)})}});a.Search=function(u,v){v=v||{};v.q=u;return e("GET","people/search",q(v,["q","limit"])).then(function(w){return w.list.map(a.Cache)})};a.List=function(u){u=u||{};return e("GET","people",q(u,["limit","offset"])).then(function(v){return v.list.map(a.Cache)})};a.Cache=function(v){var u=new a(v);d[u.id]=u;return u};var d={};a.Get=function(u){if(u in d){return promised(d[u])}return new a(u).Load()};function n(u){p(this,u,["id","label","count","audience","access"])}n.prototype=Object.create({Create:function(){var u=this;return e("POST","groups",{},q(this,["id","label","audience"])).then(function(v){n.call(u,v);return u})},List:function(u){u=u||{};return e("GET",["groups",this.id],q(u,["limit","offset"])).then(function(v){return v.list.map(a.Cache)})},Load:function(){var u=this;return e("GET",["groups",this.id,"info"]).then(function(v){n.call(u,v);return u})},Save:function(){return e("PUT",["groups",this.id,"info"],{},q(this,["label","audience"]))},Delete:function(){return e("DELETE",["groups",this.id])},Add:function(u){return this.AddMany([u])},Remove:function(u){return this.RemoveMany([u])},AddMany:function(u){return e("POST",["groups",this.id,"add"],{},u.map(m))},RemoveMany:function(u){return e("POST",["groups",this.id,"remove"],{},u.map(m))},});n.List=function(u){u=u||{};return e("GET","groups",q(u,["limit","offset"])).then(function(v){return v.list.map(function(w){return new n(w)})})};var o={Persona:function(u){return e("POST","people/auth/persona",{},{assertion:u}).then(function(v){return a.Cache(v.self)})},HMAC:function(u){u=q(u,["id","expires","key","proof"]);return e("POST","people/auth/hmac",{},u).then(function(v){return a.Cache(v.self)})}};function g(u){p(this,u,["id","key"])}g.prototype=Object.create({Create:function(){var u=this;return e("POST","keys",{},{key:this.key,hash:"SHA-1",encoding:"hex"}).then(function(v){g.call(u,v);return u})}});function l(u){p(this,u,["id"])}l.prototype=Object.create({Owner:function(){return e("GET",["tokens",this.id]).then(function(u){return a.Cache(u.self)})},Delete:function(){return e("DELETE",["tokens",this.id])}});function s(v){p(this,v,["id","chat","author","time","body","track","custom","tree"]);var u=this.tree=this.tree||{count:0,top:[]};if(u.top.length>0){u.top=u.top.map(function(w){return new s(w)})}}s.prototype=Object.create({Load:function(){var u=this;return e("GET",["chat",this.chat,"posts",this.id]).then(function(v){s.call(u,v.info);v.people.forEach(a.Cache);return u})},Delete:function(){return e("DELETE",["chat",this.chat,"posts",this.id])},Reply:function(v){var u=this;v=q(v,["body","custom"]);v.reply=this.id;return e("POST",["chat",this.chat,"posts"],{},v).then(function(w){return new b.Post({body:v.body,custom:v.custom||null,id:w.id,chat:u.chat})})},Track:function(u){return e("POST",["chat",this.chat,"posts",this.id,"track"],{},u)},Replies:function(v){var u=this;v=q(v||{},["limit","offset"]);v.under=u.id;return e("GET",["chat",this.id,"posts"],v).then(function(w){w.people.forEach(a.Cache);return w.posts.map(function(x){x.chat=u.chat;return new b.Post(x)})})}});function b(u){p(this,u,["id","subject","custom","audience","count","last","access","track"])}b.prototype=Object.create({Load:function(){var u=this;return e("GET",["chat",this.id]).then(function(v){b.call(u,v.info);return u})},Save:function(){return e("PUT",["chat",this.id],{},q(this,["subject","custom","audience"]))},Create:function(){var u=this;return e("POST","chat",{},q(this,["subject","custom","audience"])).then(function(v){u.id=v.id;return u})},Delete:function(){return e("DELETE",["chat",this.id])},Track:function(u){return e("POST",["chat",this.id,"track"],{},u)},Posts:function(v){var u=this;v=v||{};return e("GET",["chat",this.id,"posts"],q(v,["limit","offset"])).then(function(w){w.people.forEach(a.Cache);return w.posts.map(function(x){x.chat=u.id;return new b.Post(x)})})},Post:function(v){var u=this;return e("POST",["chat",this.id,"posts"],{},q(v,["body","custom"])).then(function(w){return new b.Post({body:v.body,custom:v.custom||null,id:w.id,chat:u.id})})}});b.List=function(u){u=u||{};return e("GET","chat",q(u,["limit","offset"])).then(function(v){return v.list.map(function(w){return new b(w)})})};b.Post=s;return{Person:a,Group:n,Auth:o,Key:g,Token:l,Chat:b}};